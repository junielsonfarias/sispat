╔════════════════════════════════════════════════════════════════════════╗
║                                                                        ║
║   🔒 CORREÇÃO DE PERMISSÕES DE SETORES                                ║
║                                                                        ║
║   Problema: Usuários vendo dados de todos os setores                  ║
║   Solução: Filtro por responsibleSectors no backend                   ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝


════════════════════════════════════════════════════════════════════════
  ⚠️  URGÊNCIA: ALTA (Vazamento de dados por permissão)
════════════════════════════════════════════════════════════════════════

PROBLEMA:
- Usuários vendo locais de TODOS os setores
- Usuários vendo lista de TODOS os setores
- Vazamento de informações entre setores


════════════════════════════════════════════════════════════════════════
  🚀 EXECUTAR NO SERVIDOR (COPIE TUDO)
════════════════════════════════════════════════════════════════════════

cd /var/www/sispat && \
git pull origin main && \
echo "✅ Código atualizado" && \
cd backend && npm run build && cd .. && \
echo "✅ Backend compilado" && \
pm2 restart sispat-backend && \
sleep 3 && \
echo "✅ Backend reiniciado" && \
pm2 logs sispat-backend --lines 30 --nostream


════════════════════════════════════════════════════════════════════════
  ✅ O QUE FOI CORRIGIDO
════════════════════════════════════════════════════════════════════════

✅ Locais (GET /api/locais)
   - ANTES: Retornava TODOS os locais
   - DEPOIS: Filtra por setores do usuário

✅ Setores (GET /api/sectors)
   - ANTES: Retornava TODOS os setores
   - DEPOIS: Filtra por responsibleSectors

✅ Logs de Debug
   - Adicionados logs detalhados para diagnóstico


════════════════════════════════════════════════════════════════════════
  🧪 TESTAR APÓS DEPLOY
════════════════════════════════════════════════════════════════════════

TESTE 1: Login como USUÁRIO (não admin/supervisor)
────────────────────────────────────────────────────
1. Fazer login com usuário normal
2. Ir em "Locais"
3. ✅ Deve ver APENAS locais dos setores atribuídos
4. ❌ NÃO deve ver locais de outros setores


TESTE 2: Login como SUPERVISOR
────────────────────────────────────────────────────
1. Login: supervisor@ssbv.com / Master6273@
2. Ir em "Locais"
3. ✅ Deve ver TODOS os locais


TESTE 3: Verificar Logs (Diagnóstico)
────────────────────────────────────────────────────
Execute no servidor:
pm2 logs sispat-backend --lines 100

Procure por:
🔍 [DEV] GET /api/locais - Usuário: { role: ...
🔍 [DEV] Setores responsáveis do usuário: [...]
✅ [DEV] Locais encontrados: X


════════════════════════════════════════════════════════════════════════
  📊 MATRIZ DE PERMISSÕES
════════════════════════════════════════════════════════════════════════

┌───────────────┬──────────┬────────────┬──────────┬──────────────┐
│ Recurso       │ Admin    │ Supervisor │ Usuário  │ Visualizador │
├───────────────┼──────────┼────────────┼──────────┼──────────────┤
│ Locais        │ TODOS    │ TODOS      │ Filtrado │ Filtrado     │
│ Setores       │ TODOS    │ TODOS      │ Filtrado │ Filtrado     │
│ Bens          │ TODOS    │ TODOS      │ Filtrado │ Filtrado     │
│ Imóveis       │ TODOS    │ TODOS      │ Filtrado │ Filtrado     │
└───────────────┴──────────┴────────────┴──────────┴──────────────┘


════════════════════════════════════════════════════════════════════════
  ℹ️  IMPORTANTE
════════════════════════════════════════════════════════════════════════

⚠️  APENAS O BACKEND FOI ALTERADO
   - Frontend NÃO precisa ser recompilado
   - Apenas reiniciar o backend é suficiente

⚠️  USUÁRIOS SEM SETORES ATRIBUÍDOS
   - Se usuário não tiver setores em responsibleSectors
   - Ele NÃO verá nenhum dado
   - Isso é intencional por segurança


════════════════════════════════════════════════════════════════════════
  📝 VERIFICAÇÃO RÁPIDA
════════════════════════════════════════════════════════════════════════

Após executar os comandos:

[ ] Git pull executado
[ ] Backend compilado
[ ] Backend reiniciado
[ ] Logs verificados (sem erros)
[ ] Teste 1: Usuário vê apenas seus locais
[ ] Teste 2: Supervisor vê todos os locais
[ ] Teste 3: Logs de debug aparecem


════════════════════════════════════════════════════════════════════════
  🆘 SE DER PROBLEMA
════════════════════════════════════════════════════════════════════════

Rollback:
cd /var/www/sispat
git checkout 094c082
cd backend && npm run build
pm2 restart sispat-backend

Verificar logs:
pm2 logs sispat-backend --err


════════════════════════════════════════════════════════════════════════
  📚 DOCUMENTAÇÃO
════════════════════════════════════════════════════════════════════════

Detalhes técnicos:
- CORRECAO_PERMISSOES_SETORES.md

Commit:
- https://github.com/junielsonfarias/sispat/commit/165fc10


════════════════════════════════════════════════════════════════════════

        🎯 Execute os comandos e me avise o resultado!

════════════════════════════════════════════════════════════════════════

